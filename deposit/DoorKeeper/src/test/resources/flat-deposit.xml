<?xml version="1.0" encoding="UTF-8"?>
<flow>
    <config>
        <import class="nl.mpi.tla.flat.deposit.context.Environment" prefix="env-"/>
        <import class="nl.mpi.tla.flat.deposit.context.SystemProperties" prefix="sys-"/>
        <import class="nl.mpi.tla.flat.deposit.context.CLIParameters" prefix="param-"/>
        <property name="work" value="{$param-base}/workdir/{$param-user}" uniq="true"/>
        <property name="epicPrefix" value="12345"/>
        <property name="epicUser" value="test"/>
        <property name="epicPassword" value="test"/>
        <property name="epicServer" value="http://www.pidconsortium.eu/"/>
        <property name="fedoraUser" value="fedoraAdmin"/>
        <property name="fedoraPassword" value="fedora"/>
        <property name="fedoraServer" value="https://localhost:8443/fedora"/>
        <property name="fitsFolder" value="lib/fits-0.8.10"/>
    </config>
    <init>
        <action id="logSetup" name="log" class="nl.mpi.tla.flat.deposit.action.WorkspaceLogSetup">
            <parameter name="dir" value="{$work}/logs"/>
        </action>        
    </init>
    <main>
        <action name="check workspace" class="nl.mpi.tla.flat.deposit.action.SIPLoad"/>
        <action name="assemble package" class="nl.mpi.tla.flat.deposit.action.PackageAssembly">
            <parameter name="dir" value="{$work}/resources"/>
            <parameter name="prefix" value="{$epicPrefix}"/>
        </action>
        <action name="validate metadata" class="nl.mpi.tla.flat.deposit.action.Validate">
            <parameter name="rules" value="{$param-base}/policies/rules.sch"/>
        </action>
        <action name="validate resources" class="nl.mpi.tla.flat.deposit.action.FITS">
        	<parameter name="fits_home" value="{$fitsFolder}"/>
        	<parameter name="mimetypes" value="{$param-base}/policies/fits-mimetypes.xml"/>
        </action>
        <action name="quality assessment" class="nl.mpi.tla.flat.deposit.action.QualityAssessment"/>
        <action name="manual evaluation" class="nl.mpi.tla.flat.deposit.action.Evaluate"/>
        <action name="persist resources" class="nl.mpi.tla.flat.deposit.action.Persist">
            <parameter name="data" value="{$param-base}/data"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.Versions"/>
        <action class="nl.mpi.tla.flat.deposit.action.HandleAssignment">
            <parameter name="prefix" value="{$epicPrefix}"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.Relate"/>
        <action class="nl.mpi.tla.flat.deposit.action.Deposit">
            <parameter name="fedoraServer" value="{$fedoraServer}"/>
            <parameter name="fedoraUser" value="{$fedoraUser}"/>
            <parameter name="fedoraPassword" value="{$fedoraPassword}"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.ACL"/>
        <action class="nl.mpi.tla.flat.deposit.action.HandleCreation">
            <parameter name="epicServer" value="{$epicServer}"/>
            <parameter name="epicPrefix" value="{$epicPrefix}"/>
            <parameter name="epicUser" value="{$epicUser}"/>
            <parameter name="epicPassword" value="{$epicPassword}"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.Index"/>
        <action class="nl.mpi.tla.flat.deposit.action.WorkspaceCleanup"/>        
    </main>
    <exception>
        <action name="log" class="nl.mpi.tla.flat.deposit.action.Log"/>
    </exception>
    <final>
        <action id="logSetup" name="log" class="nl.mpi.tla.flat.deposit.action.WorkspaceLogCleanup"/>        
    </final>
</flow>
